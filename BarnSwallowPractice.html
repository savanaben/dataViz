<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Drag Network Example</title>
        <script type="text/javascript" src= "https://d3js.org/d3.v7.min.js"></script>
        <style type="text/css">
  

.links line {
  stroke: #999;
  stroke-opacity: 0.6;
}
.node {
  fill: rgb(63, 148, 24);
  stroke: rgb(255, 255, 255);
  stroke-width: 2px;
}
.nodes circle {
  stroke: #fff;
  stroke-width: 1.5px;
}

.label {
  font-family: sans-serif;
  font-size: 12px;
  fill: #0057bb;
  font-weight: 700;


}

        </style>
    </head>
    <body>
        <svg width="1500" height="1500">
          <filter x="0" y="0" width="1" height="1" id="removebackground">
            <feFlood flood-color="white"/>
            <feComposite in="SourceGraphic"/>
         </filter>
        </svg>

        <script type="text/javascript">
           
          
            const svg = d3.select("svg");
            const w = 1500;
            const h= 1500; 
            const myColor = d3.scaleOrdinal(d3.schemeTableau10);
            
            
            var color = d3.scale.category10();
         
           
           
            Promise.all([
                d3.csv("SF_nodes.csv"),
                d3.csv("SF_edges.csv"),
            ]).then(function(files) {
                // files[0] will contain nodes.csv
                // files[1] will contain links.csv
                // remember to put + when the field has #s in it
                const dataset = {
                 
                 
                  "nodes": files[0].map(d => { return {"id": +d.id, "name": d.name, "group": +d.group}}),
                 // "nodes": files[0].map(d => { return {"id": +d.id, "name": d.name}}),
                  "links": files[1].map(d => { return {"source": +d.source, "target": +d.target, "weight": +d.weight}})
                };
                 console.log(dataset)



                 var linkStrengthScale = d3.scaleLinear()
                      .range([.3, 1]);


              



            //force simulation
            const simulation = d3.forceSimulation(dataset.nodes)
                              //  .force("charge", d3.forceManyBody().strength(500))
                              //  .force("link", d3.forceLink(dataset.links).distance(.5).strength(.5))
                                  .force("link", d3.forceLink(dataset.links).distance(1).strength(function(d) {
            return linkStrengthScale(d.weight);
        }))
                       
                               
                                .force("center", d3.forceCenter().x(w/2).y(h/2).strength(.05))
                                .force("collide",d3.forceCollide().radius(70).strength(.07));


            // links (lines) -- note: .join() instead of .enter().append()
            const links = svg.selectAll("line")
                             .data(dataset.links)
                             .join("line") //join
                             .style("stroke", "#949494")
                             //.style("stroke-width", .5); 
                             .style("stroke-width", d=> d.weight *.12); //could be set to data /connection strength 

             // nodes (circles) - replaced with below nodes var, which creates a svg group with the nodes and text labels. 
/*             const nodes = svg.selectAll("circle")
                             .data(dataset.nodes)
                             .join("circle") //join
                             .attr("r", 7) 
                             .style("fill", (d,i)=>myColor(i))
                             .call(d3.drag() // using .call() to call our drag event
                                .on("start", dragstarted)
                                .on("drag", dragged)
                                .on("end", dragended));  
                                */
       
                                

                              
var nodes = svg.selectAll("g.nodes")
  .data(dataset.nodes)
  .join("g")
  .call(d3.drag() // using .call() to call our drag event
                                .on("start", dragstarted)
                                .on("drag", dragged)
                              //  .on("mouseover", mouseover)
                              //  .on("mouseout", mouseout)
                                .on("end", dragended));

   


                                
  nodes.append('circle')
      .attr("r", 7)
    //.attr("class", "node")
      .style("fill", function(d) { return color(d.group); })


      nodes.append("text")
      .text(function(d) {
        return d.name;
      })
      .attr("class", "label")
      .attr('x', 8)
      .attr('y', 4)
      .attr("filter", "url(#removebackground)");




// consider some hovering - https://jonathansoma.com/tutorials/d3/clicking-and-hovering/
      



/*    const node = svg.append("g")
    .selectAll(".node")
    .data(dataset.nodes)
    .join("g")
      .attr('class', 'node')
      .call(drag(simulation));

      nodes.append("text")
      .text(function(d) {
        return d.name;
      })
      .style('fill', '#000')
      .style('font-size', '12px')
      .attr('x', 6)
      .attr('y', 3); 

      node.append('circle')
      .attr("r", 5)
      .attr("fill", blue);
 */

/*   const node = svg.append("g")
    .selectAll(".node")
    .data(dataset.nodes)
    .join("g")
      .attr('class', 'node')
      .call(drag(simulation));

  node.append('circle')
      .attr("r", 5)
      .attr("fill", color);
  
  node.append("text")
      .text(function(d) {
        return d.name;
      })
      .style('fill', '#000')
      .style('font-size', '12px')
      .attr('x', 6)
      .attr('y', 3); */



            //force ticks
            simulation.on("tick", (event,d)=>{
              
              links.attr("x1", d=>d.source.x)
                   .attr("y1", d=>d.source.y)
                   .attr("x2", d=>d.target.x)
                   .attr("y2", d=>d.target.y);

              nodes
                   .attr("transform", d => `translate(${d.x}, ${d.y})`);
            
            });
          

            //Drag events
            function dragstarted(event) {
              if (!event.active) simulation.alphaTarget(.01).restart();
              event.subject.fx = event.subject.x;
              event.subject.fy = event.subject.y;
            }
            
            function dragged(event) {
              event.subject.fx = event.x;
              event.subject.fy = event.y;
            }
            
            function dragended(event) {
              if (!event.active) simulation.alphaTarget(.01);
              event.subject.fx = null;
              event.subject.fy = null;
            }
  
  // this would align with the mouseover above, but does not currently work          
/*             function mouseover() {
  d3.select(this).select("circle").transition()
      .duration(750)
      .attr("r", 16);
}

function mouseout() {
  d3.select(this).select("circle").transition()
      .duration(750)
      .attr("r", 8);
}
 */

            console.log(dataset);
           
          });
            
        </script>
    </body>
</html>