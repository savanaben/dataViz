<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Drag Network Example</title>
        <script type="text/javascript" src= "https://d3js.org/d3.v7.min.js"></script>



        <style type="text/css">
                .links line {
                  stroke: #999;
                  stroke-opacity: 0.6;
                }
                .node {
                  fill: rgb(63, 148, 24);
                  stroke: rgb(255, 255, 255);
                  stroke-width: 2px;
                }
                .nodes circle {
                  stroke: #fff;
                  stroke-width: 1.5px;
                }

                .label {
                  font-family: sans-serif;
                  font-size: 12px;
                  fill: #b8b8b8;
                  font-weight: 700;
                }

                html {
                  background-color: rgb(4, 0, 15);
                  color: rgb(238, 238, 238);
                }

                h3 {
                    font-family: roboto;
                    font-size: 16px;
                    margin: 0 0 1rem 0;
                }
                
                h4 {
                    font-family: roboto;
                    font-size: 14px;
                    font-weight: 400;
                    margin: 0 0 1rem 0;
                }

                p {
                    font-family: roboto;
                    font-size: 12px;
                    font-weight: 400;
                    margin: 0 0 1rem 0;
                }

                wrapclass {
                    font-family: roboto;
                    font-size: 13px;
                    margin: 0;
                }



        </style>

    </head>
    <body>
        <svg width="1920" height="1500">
          <filter x="0" y="0" width="1" height="1" id="removebackground">
            <feFlood flood-color="black" flood-opacity="0.65"/>
            <feComposite in="SourceGraphic"/>
         </filter>
        </svg>

        <script type="text/javascript">
          


            const svg = d3.select("svg");
            const w = 1920;
            const h= 1500; 
          //const myColor = d3.scaleOrdinal(d3.schemeTableau10);
            var color = d3.scaleOrdinal([`#DF1BFF`, `#00D5E2`]);
           
           //wrap text vars
           //top number is vertical position
            var horizontalTreeOffset = 6;
            var horizontalNodeOffset = horizontalTreeOffset - 0;
            var horizontalNodeOffsetLeaf = horizontalTreeOffset + 5;
           

            // tweaks the pulling strength of the nodes based on the weight data
            var linkStrengthScale = d3.scaleLinear()
                .range([.3, 1]);


            // tweaks the node size
            var nodeSize = d3.scaleLinear()
            .domain([0, 11]) // unit: km
            .range([4, 10]); // unit: pixels
            
      



            Promise.all([
                d3.csv("SF_nodes.csv"),
                d3.csv("SF_edges.csv"),
            ]).then(function(files) {
                // files[0] will contain nodes.csv
                // files[1] will contain links.csv
                // remember to put + when the field has #s in it
                const dataset = {
                 
                 
                  "nodes": files[0].map(d => { return {"id": +d.id, "name": d.name, "group": +d.group, "frequency": +d.frequency, "author": d.author, "date": d.date}}),
                  "links": files[1].map(d => { return {"source": +d.source, "target": +d.target, "weight": +d.weight}})
                };
                 console.log(dataset)





            //force simulation
            const simulation = d3.forceSimulation(dataset.nodes)
                              //  .force("charge", d3.forceManyBody().strength(500))
                              //  .force("link", d3.forceLink(dataset.links).distance(.5).strength(.5))
                                  .force("link", d3.forceLink(dataset.links).distance(1).strength(function(d) {
            return linkStrengthScale(d.weight);
        }))
                       
                               
                                .force("center", d3.forceCenter().x(w/2).y(h/2).strength(.05))
                                .force("collide",d3.forceCollide().radius(80).strength(.07));


            // links (lines) -- note: .join() instead of .enter().append()
            const links = svg.selectAll("line")
                             .data(dataset.links)
                             .join("line") //join
                             .style("stroke", "#949494")
                             //.style("stroke-width", .5); 
                             .style("stroke-width", d=> d.weight *.12); //could be set to data /connection strength 

             // nodes (circles) - replaced with below nodes var, which creates a svg group with the nodes and text labels. 
/*             const nodes = svg.selectAll("circle")
                             .data(dataset.nodes)
                             .join("circle") //join
                             .attr("r", 7) 
                             .style("fill", (d,i)=>myColor(i))
                             .call(d3.drag() // using .call() to call our drag event
                                .on("start", dragstarted)
                                .on("drag", dragged)
                                .on("end", dragended));  
                                */
       
                                

                              
var nodes = svg.selectAll("g.nodes")
  .data(dataset.nodes)
  .join("g")
  .call(d3.drag() // using .call() to call our drag event
                                .on("start", dragstarted)
                                .on("drag", dragged)
                              //  .on("mouseover", mouseover)
                              //  .on("mouseout", mouseout)
                                .on("end", dragended))

                                
  

                         
  nodes.append('circle')
    //  .attr("r", 8)
    //.attr("r", function(d) { return d.frequency * 1; })
    .attr("r", function(d) { return nodeSize (d.frequency * 1);})
   
  

    //.attr("class", "node")
      .style("fill", function(d) { return color(d.group); })
      .on("click", clicknode);

/*       nodes.append("text")
      .text(function(d) {
        return d.name;
      })
      .attr("class", "label")
      .attr('x', 12)
      .attr('y', 4)
      .attr("filter", "url(#removebackground)"); */


      nodes.append("svg:foreignObject")
              .attr("width", "100")
              .attr("height", "50")
              .attr("x", function(d) { return d.children || d._children ? horizontalNodeOffset - 50 : horizontalNodeOffsetLeaf; })
              //the second number here is vertical position
              .attr("y", function(d) { return d.children || d._children ? -40 : -8; })
              .style("font", "normal 12px Arial")
              .style("text-shadow", "0 0 3px #000000, 0 0 3px #000000, 0 0 3px #000000,0 0 3px #000000, 0 0 5px #000000, 0 0 5px #000000, 0 0 5px #000000")


            .append("xhtml:wrapclass")
              .attr("xmlns", "http://www.w3.org/1999/xhtml")
              .html(function(d){ return  d.name ; });

   /*  nodes.append("svg:foreignObject")
              .attr("width", "140")
              .attr("height", "40")
              .attr("x", function(d) { return d.children || d._children ? horizontalNodeOffset - 50 : horizontalNodeOffsetLeaf; })
              .attr("y", function(d) { return d.children || d._children ? -40 : -17; })
              .style("font", "normal 12px Arial")
              .style("background-color", "rgba(0, 0, 0, 0.67)")
            .append("xhtml:body")
              .attr("xmlns", "http://www.w3.org/1999/xhtml")
              .html(function(d){ return  d.name ; });

 */


  function clicknode(event, nodes) {

    const[x, y] = d3.pointer(event);
    
  console.log("click on circle")
  
/*   const[x, y] = d3.pointer(event);
  
  tooltip.style("left", (x)+"px")
         .style("top", (y)+"px") */

/*   tooltip.style("left", (x)+"px")
         .style("top", (y)+"px") */

  tooltip
    .style("left", `${event.layerX}px`)
    .style("top", `${event.layerY}px`)


    .transition().duration(200).style("opacity", 1);
  
  
  // d3.event.stopPropagation();
  
  loadTooltipContent(nodes);
}



 // add html content to tooltip
  function loadTooltipContent(nodes) {
      var htmlContent = "<div>";
      htmlContent += "<h3>" + nodes.name + "<\/h3>"
      htmlContent += "<h4>by " + nodes.author + "<\/h4>"
      htmlContent += "<p>Published " + nodes.date + "<\/p>"


    //  htmlContent += "<br>"
    //  htmlContent += "<br><br>"
      htmlContent += "<\/div>"
      tooltip.html(htmlContent);
  }



  // add tooltip to HTML body
  var tooltip = d3.select("body")
    .append("div")
    .attr("class", "tooltip")
    .style("position", "absolute")
    .style("padding", "12px")
    .style("z-index", "10")
    .style("width", "200px")
    .style("height", "110px")
    .style("background-color", "#090020")
    .style("border-radius", "6px")
    .style("box-shadow", "0px 2px 5px 1px rgba(0,0,0,0.24")

    .style("opacity", "0")
    .text("");



d3.select("body").on("click", function() {
  console.log("click on body")
  tooltip.style("opacity", 0)
})


      



 //this is trying to remove the popover on click, but its conflicting with the addition of the popover. propogation related? 

/* d3.select("body").on("click", function() {
  console.log("click on body")
  tooltip.style("opacity", 0)
})
 */










// consider some hovering - https://jonathansoma.com/tutorials/d3/clicking-and-hovering/
      



/*    const node = svg.append("g")
    .selectAll(".node")
    .data(dataset.nodes)
    .join("g")
      .attr('class', 'node')
      .call(drag(simulation));

      nodes.append("text")
      .text(function(d) {
        return d.name;
      })
      .style('fill', '#000')
      .style('font-size', '12px')
      .attr('x', 6)
      .attr('y', 3); 

      node.append('circle')
      .attr("r", 5)
      .attr("fill", blue);
 */

/*   const node = svg.append("g")
    .selectAll(".node")
    .data(dataset.nodes)
    .join("g")
      .attr('class', 'node')
      .call(drag(simulation));

  node.append('circle')
      .attr("r", 5)
      .attr("fill", color);
  
  node.append("text")
      .text(function(d) {
        return d.name;
      })
      .style('fill', '#000')
      .style('font-size', '12px')
      .attr('x', 6)
      .attr('y', 3); */



            //force ticks
            simulation.on("tick", (event,d)=>{
              
              links.attr("x1", d=>d.source.x)
                   .attr("y1", d=>d.source.y)
                   .attr("x2", d=>d.target.x)
                   .attr("y2", d=>d.target.y);

              nodes
                   .attr("transform", d => `translate(${d.x}, ${d.y})`);
            
            });
          

            //Drag events
            function dragstarted(event) {
              if (!event.active) simulation.alphaTarget(.002).restart();
              event.subject.fx = event.subject.x;
              event.subject.fy = event.subject.y;
            }
            
            function dragged(event) {
              event.subject.fx = event.x;
              event.subject.fy = event.y;
            }
            
            function dragended(event) {
              if (!event.active) simulation.alphaTarget(.002);
              event.subject.fx = null;
              event.subject.fy = null;
            }
  
  // this would align with the mouseover above, but does not currently work          
/*             function mouseover() {
  d3.select(this).select("circle").transition()
      .duration(750)
      .attr("r", 16);
}

function mouseout() {
  d3.select(this).select("circle").transition()
      .duration(750)
      .attr("r", 8);
}
 */

            console.log(dataset);
           
          });
            
        </script>
    </body>
</html>